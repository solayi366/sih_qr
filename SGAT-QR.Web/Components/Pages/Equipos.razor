@page "/equipos"
@using SGAT_QR.Core.Entities
@using SGAT_QR.Core.Interfaces
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize]
@inject IEquipoService EquipoService
@inject IDialogService DialogService
@inject ISnackbar Snackbar
@inject IJSRuntime JS

<MudText Typo="Typo.h4" Color="Color.Primary" Class="mb-6 font-weight-bold">Inventario de Equipos</MudText>

<MudTable Items="@_equipos" Hover="true" Elevation="4" Loading="@_loading" 
          Filter="new Func<Equipo,bool>(FilterFunc1)" Class="rounded-lg border-t-4 border-solid" Style="border-color: #9B111E;">
    <ToolBarContent>
        <MudButton Variant="Variant.Filled" Color="Color.Primary" StartIcon="@Icons.Material.Filled.Add" 
                   OnClick="AbrirDialogoNuevo" Class="rounded-pill px-6 mr-2">Nuevo Activo</MudButton>
        <MudButton Variant="Variant.Outlined" Color="Color.Success" StartIcon="@Icons.Custom.FileFormats.FileExcel" 
                   OnClick="ExportarExcel" Class="rounded-pill px-6">Exportar</MudButton>
        <MudSpacer />
        <MudTextField @bind-Value="_searchString" Placeholder="Buscar..." Adornment="Adornment.Start" 
                      AdornmentIcon="@Icons.Material.Filled.Search" IconSize="Size.Medium" Class="mt-0" Immediate="true" />
    </ToolBarContent>
    <HeaderContent>
        <MudTh Style="background-color: #9B111E; color: white;">Nomenclatura</MudTh>
        <MudTh Style="background-color: #9B111E; color: white;">Marca / Modelo</MudTh>
        <MudTh Style="background-color: #9B111E; color: white;">Serial</MudTh>
        <MudTh Style="background-color: #9B111E; color: white;">QR</MudTh>
        <MudTh Style="background-color: #9B111E; color: white;">Estado</MudTh>
        <MudTh Style="background-color: #9B111E; color: white; width: 180px;">Acciones</MudTh>
    </HeaderContent>
    <RowTemplate>
        <MudTd>@context.Nomenclatura</MudTd>
        <MudTd>@context.Marca @context.Modelo</MudTd>
        <MudTd>@context.Serial</MudTd>
        <MudTd>
            @if (!string.IsNullOrEmpty(context.QRCodeUrl))
            {
                <img src="@context.QRCodeUrl" width="40" height="40" class="rounded cursor-pointer" @onclick="@(() => VerDetalle(context))" />
            }
        </MudTd>
        <MudTd>
            <MudChip T="string" Color="@(context.Estado == "Activo" ? Color.Success : Color.Error)" Size="Size.Small">@context.Estado</MudChip>
        </MudTd>
        <MudTd>
            <MudIconButton Icon="@Icons.Material.Filled.Visibility" Color="Color.Primary" OnClick="@(() => VerDetalle(context))" />
            <MudIconButton Icon="@Icons.Material.Filled.Edit" Color="Color.Info" OnClick="@(() => AbrirDialogoEditar(context))" />
            <MudIconButton Icon="@Icons.Material.Filled.Delete" Color="Color.Error" OnClick="@(() => Eliminar(context.Id))" />
        </MudTd>
    </RowTemplate>
</MudTable>

@code {
    private List<Equipo> _equipos = new();
    private bool _loading = true;
    private string _searchString = "";

    protected override async Task OnInitializedAsync() => await CargarEquipos();

    private async Task CargarEquipos()
    {
        _loading = true;
        _equipos = await EquipoService.ObtenerTodosAsync() ?? new List<Equipo>();
        _loading = false;
    }

    private async Task ExportarExcel()
    {
        var bytes = await EquipoService.GenerarExcelAsync();
        var fileName = $"Inventario_Equipos_{DateTime.Now:yyyyMMdd}.xlsx";
        await JS.InvokeVoidAsync("descargarArchivo", fileName, Convert.ToBase64String(bytes));
        Snackbar.Add("Reporte generado con éxito", Severity.Success);
    }

    private async Task VerDetalle(Equipo equipo)
    {
        var parameters = new DialogParameters { ["Equipo"] = equipo };
        await DialogService.ShowAsync<EquipoDetalleDialog>("Ficha Técnica", parameters, new DialogOptions { MaxWidth = MaxWidth.Medium, FullWidth = true });
    }

    private async Task AbrirDialogoNuevo()
    {
        var tipos = await EquipoService.ObtenerTiposAsync();
        var deps = await EquipoService.ObtenerDependenciasAsync();
        var parameters = new DialogParameters { ["Equipo"] = new Equipo { Estado = "Activo" }, ["Tipos"] = tipos, ["Dependencias"] = deps };
        var dialog = await DialogService.ShowAsync<EquipoDialog>("Registrar", parameters, new DialogOptions { MaxWidth = MaxWidth.Medium, FullWidth = true });
        if (!(await dialog.Result).Canceled) await CargarEquipos();
    }

    private async Task AbrirDialogoEditar(Equipo equipo)
    {
        var tipos = await EquipoService.ObtenerTiposAsync();
        var deps = await EquipoService.ObtenerDependenciasAsync();
        var parameters = new DialogParameters { ["Equipo"] = equipo, ["Tipos"] = tipos, ["Dependencias"] = deps };
        var dialog = await DialogService.ShowAsync<EquipoDialog>("Editar", parameters, new DialogOptions { MaxWidth = MaxWidth.Medium, FullWidth = true });
        if (!(await dialog.Result).Canceled) await CargarEquipos();
    }

    private async Task Eliminar(int id)
    {
        bool? confirm = await DialogService.ShowMessageBox("Atención", "¿Desea eliminar este equipo?", "Eliminar", "Cancelar");
        if (confirm == true && await EquipoService.EliminarAsync(id)) await CargarEquipos();
    }

    private bool FilterFunc1(Equipo element) => FilterFunc(element, _searchString);
    private bool FilterFunc(Equipo element, string searchString)
    {
        if (string.IsNullOrWhiteSpace(searchString)) return true;
        return element.Nomenclatura.Contains(searchString, StringComparison.OrdinalIgnoreCase) || 
               element.Serial.Contains(searchString, StringComparison.OrdinalIgnoreCase);
    }
}