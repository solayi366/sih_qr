@page "/perifericos"
@using SGAT_QR.Core.Entities
@using SGAT_QR.Core.Interfaces
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize]
@inject IPerifericoService PerifericoService
@inject IDialogService DialogService
@inject ISnackbar Snackbar
@inject IJSRuntime JS

<MudText Typo="Typo.h4" Color="Color.Secondary" Class="mb-6 font-weight-bold">Inventario de Periféricos</MudText>

<MudTable Items="@_perifericos" Hover="true" Elevation="4" Loading="@_loading" 
          Filter="new Func<Periferico,bool>(FilterFunc1)" 
          Class="rounded-lg border-t-4 border-solid" Style="border-color: #263238;">
    <ToolBarContent>
        <MudButton Variant="Variant.Filled" Color="Color.Secondary" 
                   StartIcon="@Icons.Material.Filled.Add" OnClick="AbrirNuevo" 
                   Class="rounded-pill px-6 mr-2">Nuevo Periférico</MudButton>
        <MudButton Variant="Variant.Outlined" Color="Color.Success" StartIcon="@Icons.Custom.FileFormats.FileExcel" 
                   OnClick="ExportarExcel" Class="rounded-pill px-6">Exportar</MudButton>
        <MudSpacer />
        <MudTextField @bind-Value="_search" Placeholder="Buscar por serial o marca..." 
                      Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.Search" 
                      Class="mt-0" Immediate="true" />
    </ToolBarContent>
    <HeaderContent>
        <MudTh Style="background-color: #263238; color: white;">Tipo</MudTh>
        <MudTh Style="background-color: #263238; color: white;">Marca / Modelo</MudTh>
        <MudTh Style="background-color: #263238; color: white;">Serial</MudTh>
        <MudTh Style="background-color: #263238; color: white;">Equipo Vinculado</MudTh>
        <MudTh Style="background-color: #263238; color: white;">QR</MudTh>
        <MudTh Style="background-color: #263238; color: white; width: 150px;">Acciones</MudTh>
    </HeaderContent>
    <RowTemplate>
        <MudTd DataLabel="Tipo">@(context.TipoPeriferico?.Nombre ?? "N/A")</MudTd>
        <MudTd DataLabel="Marca/Modelo">@($"{context.Marca} {context.Modelo}")</MudTd>
        <MudTd DataLabel="Serial">@context.Serial</MudTd>
        <MudTd DataLabel="Equipo">
            @if (context.Equipo != null)
            {
                <MudChip T="string" Icon="@Icons.Material.Filled.Link" Color="Color.Info" Size="Size.Small">
                    @(context.Equipo?.Nomenclatura ?? "S/N")
                </MudChip>
            }
        </MudTd>
        <MudTd DataLabel="QR">
            @if (!string.IsNullOrEmpty(context.QRCodeUrl))
            {
                <img src="@context.QRCodeUrl" width="40" height="40" class="rounded cursor-pointer" @onclick="@(() => VerDetalle(context))" />
            }
        </MudTd>
        <MudTd>
            <MudIconButton Icon="@Icons.Material.Filled.Visibility" Color="Color.Primary" OnClick="@(() => VerDetalle(context))" />
            <MudIconButton Icon="@Icons.Material.Filled.Edit" Color="Color.Info" OnClick="@(() => AbrirEditar(context))" />
            <MudIconButton Icon="@Icons.Material.Filled.Delete" Color="Color.Error" OnClick="@(() => Eliminar(context.Id))" />
        </MudTd>
    </RowTemplate>
</MudTable>

@code {
    private List<Periferico> _perifericos = new();
    private bool _loading = true;
    private string _search = "";

    protected override async Task OnInitializedAsync() => await Cargar();

    private async Task Cargar()
    {
        _loading = true;
        _perifericos = await PerifericoService.ObtenerTodosAsync() ?? new List<Periferico>();
        _loading = false;
    }

    private async Task ExportarExcel()
    {
        var bytes = await PerifericoService.GenerarExcelAsync();
        await JS.InvokeVoidAsync("descargarArchivo", $"Perifericos_{DateTime.Now:yyyyMMdd}.xlsx", Convert.ToBase64String(bytes));
        Snackbar.Add("Excel generado con éxito", Severity.Success);
    }

    private async Task VerDetalle(Periferico p)
    {
        var parameters = new DialogParameters { ["Periferico"] = p };
        await DialogService.ShowAsync<PerifericoDetalleDialog>("Ficha de Periférico", parameters, new DialogOptions { MaxWidth = MaxWidth.Medium, FullWidth = true });
    }

    private async Task AbrirNuevo()
    {
        var tipos = await PerifericoService.ObtenerTiposAsync();
        var parameters = new DialogParameters { ["Periferico"] = new Periferico(), ["Tipos"] = tipos };
        var dialog = await DialogService.ShowAsync<PerifericoDialog>("Registrar", parameters, new DialogOptions { MaxWidth = MaxWidth.Small, FullWidth = true });
        if (!(await dialog.Result).Canceled) await Cargar();
    }

    private async Task AbrirEditar(Periferico p)
    {
        var tipos = await PerifericoService.ObtenerTiposAsync();
        var parameters = new DialogParameters { ["Periferico"] = p, ["Tipos"] = tipos };
        var dialog = await DialogService.ShowAsync<PerifericoDialog>("Editar", parameters, new DialogOptions { MaxWidth = MaxWidth.Small, FullWidth = true });
        if (!(await dialog.Result).Canceled) await Cargar();
    }

    private async Task Eliminar(int id)
    {
        if (await PerifericoService.EliminarAsync(id)) await Cargar();
    }

    private bool FilterFunc1(Periferico element) => FilterFunc(element, _search);
    private bool FilterFunc(Periferico element, string searchString)
    {
        if (string.IsNullOrWhiteSpace(searchString)) return true;
        return element.Serial.Contains(searchString, StringComparison.OrdinalIgnoreCase) || 
               element.Marca.Contains(searchString, StringComparison.OrdinalIgnoreCase);
    }
}