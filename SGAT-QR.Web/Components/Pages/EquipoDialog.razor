@using SGAT_QR.Core.Entities
@using SGAT_QR.Core.Interfaces
@inject IEquipoService EquipoService
@inject ISnackbar Snackbar

<MudDialog>
    <TitleContent>
        <MudText Typo="Typo.h6" Color="Color.Primary">
            <MudIcon Icon="@(Equipo.Id == 0 ? Icons.Material.Filled.AddBox : Icons.Material.Filled.Edit)" Class="mr-3 mb-n1"/>
            @(Equipo.Id == 0 ? "Registro de Activo" : $"Ficha Técnica: {Equipo.Nomenclatura}")
        </MudText>
    </TitleContent>
    <DialogContent>
        <MudTabs Elevation="2" Rounded="true" ApplyEffectsToContainer="true" PanelClass="pa-6" Color="Color.Primary">
            <MudTabPanel Text="Identificación" Icon="@Icons.Material.Filled.BrandingWatermark">
                <MudGrid>
                    <MudItem xs="12" md="6">
                        <MudTextField Label="Nomenclatura Única" @bind-Value="Equipo.Nomenclatura" Variant="Variant.Outlined" Required="true" For="@(() => Equipo.Nomenclatura)" />
                    </MudItem>
                    <MudItem xs="12" md="6">
                        <MudAutocomplete T="TipoEquipo" Label="Tipo de Equipo" Value="SelectedTipo" ValueChanged="OnTipoChanged"
                                         SearchFunc="@SearchTipoEquipo" ToStringFunc="@(e => e?.Nombre)"
                                         Variant="Variant.Outlined" Required="true" AdornmentIcon="@Icons.Material.Filled.Search" />
                    </MudItem>
                    <MudItem xs="12" md="6">
                        <MudAutocomplete T="string" Label="Marca" @bind-Value="Equipo.Marca"
                                         SearchFunc="@SearchMarcas" Variant="Variant.Outlined" Required="true" />
                    </MudItem>
                    <MudItem xs="12" md="6">
                        <MudAutocomplete T="string" Label="Modelo" @bind-Value="Equipo.Modelo"
                                         SearchFunc="@SearchModelos" Variant="Variant.Outlined" Required="true"
                                         Disabled="@(string.IsNullOrEmpty(Equipo.Marca))" />
                    </MudItem>
                    <MudItem xs="12" md="6">
                        <MudTextField Label="Número de Serial" @bind-Value="Equipo.Serial" Variant="Variant.Outlined" Required="true" />
                    </MudItem>
                </MudGrid>
            </MudTabPanel>
            <MudTabPanel Text="Hardware" Icon="@Icons.Material.Filled.Memory">
                <MudGrid>
                    <MudItem xs="12" md="4">
                        <MudTextField Label="Procesador" @bind-Value="Equipo.Procesador" Variant="Variant.Outlined" />
                    </MudItem>
                    <MudItem xs="12" md="4">
                        <MudTextField Label="Memoria RAM" @bind-Value="Equipo.RAM" Variant="Variant.Outlined" />
                    </MudItem>
                    <MudItem xs="12" md="4">
                        <MudTextField Label="Disco Duro" @bind-Value="Equipo.Disco" Variant="Variant.Outlined" />
                    </MudItem>
                </MudGrid>
            </MudTabPanel>
            <MudTabPanel Text="Red y Asignación" Icon="@Icons.Material.Filled.SettingsEthernet">
                <MudGrid>
                    <MudItem xs="12" md="6">
                        <MudTextField Label="Dirección IP" @bind-Value="Equipo.IP" Variant="Variant.Outlined" />
                    </MudItem>
                    <MudItem xs="12" md="6">
                        <MudAutocomplete T="Dependencia" Label="Dependencia" Value="SelectedDep" ValueChanged="OnDepChanged"
                                         SearchFunc="@SearchDependencia" ToStringFunc="@(e => e?.Nombre)"
                                         Variant="Variant.Outlined" Required="true" />
                    </MudItem>
                    <MudItem xs="12">
                        <MudTextField Label="Usuario Asignado" @bind-Value="Equipo.UsuarioAsignado" Variant="Variant.Outlined" />
                    </MudItem>
                </MudGrid>
            </MudTabPanel>
        </MudTabs>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Cancel">Cancelar</MudButton>
        <MudButton Color="Color.Primary" Variant="Variant.Filled" OnClick="Submit" Class="px-10">Guardar</MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] MudDialogInstance MudDialog { get; set; } = default!;
    [Parameter] public Equipo Equipo { get; set; } = new();
    [Parameter] public List<TipoEquipo> Tipos { get; set; } = new();
    [Parameter] public List<Dependencia> Dependencias { get; set; } = new();

    private TipoEquipo? SelectedTipo;
    private Dependencia? SelectedDep;

    private readonly Dictionary<string, List<string>> _catalogoMarcas = new()
    {
        ["Dell"] = new() { "Latitude 5420", "Optiplex 7090" },
        ["HP"] = new() { "EliteBook 840", "ProDesk 600" },
        ["Lenovo"] = new() { "ThinkPad X1", "ThinkCentre M70" }
    };

    protected override void OnInitialized()
    {
        SelectedTipo = Tipos.FirstOrDefault(x => x.Id == Equipo.TipoEquipoId);
        SelectedDep = Dependencias.FirstOrDefault(x => x.Id == Equipo.DependenciaId);
    }

    private void Cancel() => MudDialog.Cancel();

    private Task<IEnumerable<string>> SearchMarcas(string value, CancellationToken token)
    {
        if (string.IsNullOrEmpty(value)) return Task.FromResult<IEnumerable<string>>(_catalogoMarcas.Keys);
        return Task.FromResult(_catalogoMarcas.Keys.Where(x => x.Contains(value, StringComparison.OrdinalIgnoreCase)));
    }

    private Task<IEnumerable<string>> SearchModelos(string value, CancellationToken token)
    {
        if (string.IsNullOrEmpty(Equipo.Marca) || !_catalogoMarcas.ContainsKey(Equipo.Marca))
            return Task.FromResult<IEnumerable<string>>(new List<string>());
        var modelos = _catalogoMarcas[Equipo.Marca];
        if (string.IsNullOrEmpty(value)) return Task.FromResult<IEnumerable<string>>(modelos);
        return Task.FromResult(modelos.Where(x => x.Contains(value, StringComparison.OrdinalIgnoreCase)));
    }

    private Task<IEnumerable<TipoEquipo>> SearchTipoEquipo(string value, CancellationToken token)
    {
        if (string.IsNullOrEmpty(value)) return Task.FromResult<IEnumerable<TipoEquipo>>(Tipos);
        return Task.FromResult(Tipos.Where(x => x.Nombre.Contains(value, StringComparison.OrdinalIgnoreCase)));
    }

    private Task<IEnumerable<Dependencia>> SearchDependencia(string value, CancellationToken token)
    {
        if (string.IsNullOrEmpty(value)) return Task.FromResult<IEnumerable<Dependencia>>(Dependencias);
        return Task.FromResult(Dependencias.Where(x => x.Nombre.Contains(value, StringComparison.OrdinalIgnoreCase)));
    }

    private void OnTipoChanged(TipoEquipo tipo) { SelectedTipo = tipo; Equipo.TipoEquipoId = tipo?.Id ?? 0; }
    private void OnDepChanged(Dependencia dep) { SelectedDep = dep; Equipo.DependenciaId = dep?.Id ?? 0; }

    private async Task Submit()
    {
        if (string.IsNullOrEmpty(Equipo.Nomenclatura) || Equipo.TipoEquipoId == 0 || Equipo.DependenciaId == 0)
        {
            Snackbar.Add("Faltan campos obligatorios", Severity.Warning);
            return;
        }
        var success = await EquipoService.GuardarAsync(Equipo);
        if (success) MudDialog.Close(DialogResult.Ok(true));
    }
}