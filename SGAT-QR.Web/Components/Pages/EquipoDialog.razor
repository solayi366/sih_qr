@using SGAT_QR.Core.Entities
@using SGAT_QR.Core.Interfaces
@inject IEquipoService EquipoService
@inject ISnackbar Snackbar

<MudDialog>
    <TitleContent>
        <MudText Typo="Typo.h6" Color="Color.Primary">
            <MudIcon Icon="@(Equipo.Id == 0 ? Icons.Material.Filled.AddBox : Icons.Material.Filled.Edit)" Class="mr-3 mb-n1"/>
            @(Equipo.Id == 0 ? "Registro de Activo Pro" : $"Ficha Técnica: {Equipo.Nomenclatura}")
        </MudText>
    </TitleContent>
    <DialogContent>
        <MudTabs Elevation="2" Rounded="true" ApplyEffectsToContainer="true" PanelClass="pa-6" Color="Color.Primary">
            
            @* PESTAÑA 1: IDENTIFICACIÓN Y MARCA INTELIGENTE *@
            <MudTabPanel Text="Identificación" Icon="@Icons.Material.Filled.BrandingWatermark">
                <MudGrid>
                    <MudItem xs="12" md="6">
                        <MudTextField Label="Nomenclatura Única" @bind-Value="Equipo.Nomenclatura" Variant="Variant.Outlined" Required="true" For="@(() => Equipo.Nomenclatura)" />
                    </MudItem>
                    <MudItem xs="12" md="6">
                        <MudAutocomplete T="TipoEquipo" Label="Tipo de Equipo" Value="SelectedTipo" ValueChanged="OnTipoChanged"
                                         SearchFunc="@SearchTipoEquipo" ToStringFunc="@(e => e?.Nombre)"
                                         Variant="Variant.Outlined" Required="true" AdornmentIcon="@Icons.Material.Filled.Search" />
                    </MudItem>
                    
                    @* Autocomplete para Marcas *@
                    <MudItem xs="12" md="6">
                        <MudAutocomplete T="string" Label="Marca" @bind-Value="Equipo.Marca"
                                         SearchFunc="@SearchMarcas" Variant="Variant.Outlined" Required="true"
                                         AdornmentIcon="@Icons.Material.Filled.Business" />
                    </MudItem>

                    @* Autocomplete para Modelos (Dependiente de la Marca) *@
                    <MudItem xs="12" md="6">
                        <MudAutocomplete T="string" Label="Modelo" @bind-Value="Equipo.Modelo"
                                         SearchFunc="@SearchModelos" Variant="Variant.Outlined" Required="true"
                                         Disabled="@(string.IsNullOrEmpty(Equipo.Marca))"
                                         Placeholder="@(string.IsNullOrEmpty(Equipo.Marca) ? "Seleccione una marca primero" : "Escriba el modelo")"
                                         AdornmentIcon="@Icons.Material.Filled.Devices" />
                    </MudItem>

                    <MudItem xs="12" md="6">
                        <MudTextField Label="Número de Serial" @bind-Value="Equipo.Serial" Variant="Variant.Outlined" Required="true" />
                    </MudItem>
                    <MudItem xs="12" md="6">
                        <MudTextField Label="Serial Envia" @bind-Value="Equipo.SerialEnvia" Variant="Variant.Outlined" />
                    </MudItem>
                </MudGrid>
            </MudTabPanel>

            @* PESTAÑA 2: HARDWARE Y SISTEMA (TODOS LOS CAMPOS) *@
            <MudTabPanel Text="Especificaciones" Icon="@Icons.Material.Filled.Memory">
                <MudGrid>
                    <MudItem xs="12" md="4">
                        <MudTextField Label="Procesador" @bind-Value="Equipo.Procesador" Variant="Variant.Outlined" />
                    </MudItem>
                    <MudItem xs="12" md="4">
                        <MudTextField Label="Memoria RAM" @bind-Value="Equipo.RAM" Variant="Variant.Outlined" />
                    </MudItem>
                    <MudItem xs="12" md="4">
                        <MudTextField Label="Almacenamiento (Disco)" @bind-Value="Equipo.Disco" Variant="Variant.Outlined" />
                    </MudItem>
                    <MudItem xs="12" md="6">
                        <MudTextField Label="Sistema Operativo" @bind-Value="Equipo.SistemaOperativo" Variant="Variant.Outlined" />
                    </MudItem>
                    <MudItem xs="12" md="6">
                        <MudTextField Label="Versión SO" @bind-Value="Equipo.VersionSO" Variant="Variant.Outlined" />
                    </MudItem>
                    <MudItem xs="12">
                        <MudDatePicker Label="Fecha de Adquisición" @bind-Date="Equipo.FechaAdquisicion" Variant="Variant.Outlined" />
                    </MudItem>
                </MudGrid>
            </MudTabPanel>

            @* PESTAÑA 3: RED Y ASIGNACIÓN *@
            <MudTabPanel Text="Red y Destino" Icon="@Icons.Material.Filled.SettingsEthernet">
                <MudGrid>
                    <MudItem xs="12" md="6">
                        <MudTextField Label="Dirección IP" @bind-Value="Equipo.IP" Variant="Variant.Outlined" Mask="@(new RegexMask(@"^(\d{1,3}\.){3}\d{1,3}$"))" />
                    </MudItem>
                    <MudItem xs="12" md="6">
                        <MudTextField Label="Dirección MAC" @bind-Value="Equipo.MAC" Variant="Variant.Outlined" />
                    </MudItem>
                    <MudItem xs="12" md="6">
                        <MudAutocomplete T="Dependencia" Label="Dependencia" Value="SelectedDep" ValueChanged="OnDepChanged"
                                         SearchFunc="@SearchDependencia" ToStringFunc="@(e => e?.Nombre)"
                                         Variant="Variant.Outlined" Required="true" AdornmentIcon="@Icons.Material.Filled.Apartment" />
                    </MudItem>
                    <MudItem xs="12" md="6">
                        <MudTextField Label="Ubicación Física" @bind-Value="Equipo.Ubicacion" Variant="Variant.Outlined" />
                    </MudItem>
                    <MudItem xs="12" md="6">
                        <MudTextField Label="Usuario Asignado" @bind-Value="Equipo.UsuarioAsignado" Variant="Variant.Outlined" />
                    </MudItem>
                    <MudItem xs="12" md="6">
                        <MudSelect T="string" Label="Estado del Activo" @bind-Value="Equipo.Estado" Variant="Variant.Outlined">
                            <MudSelectItem Value="@("Activo")">Activo</MudSelectItem>
                            <MudSelectItem Value="@("Mantenimiento")">Mantenimiento</MudSelectItem>
                            <MudSelectItem Value="@("Baja")">Baja</MudSelectItem>
                        </MudSelect>
                    </MudItem>
                    <MudItem xs="12">
                        <MudTextField Label="Observaciones" @bind-Value="Equipo.Observaciones" Variant="Variant.Outlined" Lines="2" />
                    </MudItem>
                </MudGrid>
            </MudTabPanel>
        </MudTabs>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Cancel">Cancelar</MudButton>
        <MudButton Color="Color.Primary" Variant="Variant.Filled" OnClick="Submit" Class="px-10">Guardar Cambios</MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] MudDialogInstance MudDialog { get; set; } = default!;
    [Parameter] public Equipo Equipo { get; set; } = new();
    [Parameter] public List<TipoEquipo> Tipos { get; set; } = new();
    [Parameter] public List<Dependencia> Dependencias { get; set; } = new();

    private TipoEquipo? SelectedTipo;
    private Dependencia? SelectedDep;

    // Diccionario de Marcas y Modelos Precargados
    private readonly Dictionary<string, List<string>> _catalogoMarcas = new()
    {
        ["Dell"] = new() { "Latitude 5420", "Optiplex 7090", "Precision 3561", "Vostro 3400" },
        ["HP"] = new() { "EliteBook 840", "ProDesk 600", "ZBook Firefly", "Pavilion 15" },
        ["Lenovo"] = new() { "ThinkPad X1", "ThinkCentre M70", "IdeaPad 3", "Legion 5" },
        ["Apple"] = new() { "MacBook Pro M2", "MacBook Air M1", "iMac 24\"", "Mac Studio" },
        ["Asus"] = new() { "ExpertBook B1", "ROG Zephyrus", "VivoBook 14" }
    };

    protected override void OnInitialized()
    {
        SelectedTipo = Tipos.FirstOrDefault(x => x.Id == Equipo.TipoEquipoId);
        SelectedDep = Dependencias.FirstOrDefault(x => x.Id == Equipo.DependenciaId);
    }

    private void Cancel() => MudDialog.Cancel();

    // Búsqueda de Marcas
    private async Task<IEnumerable<string>> SearchMarcas(string value, CancellationToken token)
    {
        if (string.IsNullOrEmpty(value)) return _catalogoMarcas.Keys;
        return _catalogoMarcas.Keys.Where(x => x.Contains(value, StringComparison.OrdinalIgnoreCase));
    }

    // Búsqueda de Modelos (Filtrado por Marca)
    private async Task<IEnumerable<string>> SearchModelos(string value, CancellationToken token)
    {
        if (string.IsNullOrEmpty(Equipo.Marca) || !_catalogoMarcas.ContainsKey(Equipo.Marca))
            return new List<string>();

        var modelos = _catalogoMarcas[Equipo.Marca];
        if (string.IsNullOrEmpty(value)) return modelos;
        return modelos.Where(x => x.Contains(value, StringComparison.OrdinalIgnoreCase));
    }

    private async Task<IEnumerable<TipoEquipo>> SearchTipoEquipo(string value, CancellationToken token)
    {
        if (string.IsNullOrEmpty(value)) return Tipos;
        return Tipos.Where(x => x.Nombre.Contains(value, StringComparison.OrdinalIgnoreCase));
    }

    private async Task<IEnumerable<Dependencia>> SearchDependencia(string value, CancellationToken token)
    {
        if (string.IsNullOrEmpty(value)) return Dependencias;
        return Dependencias.Where(x => x.Nombre.Contains(value, StringComparison.OrdinalIgnoreCase));
    }

    private void OnTipoChanged(TipoEquipo tipo) { SelectedTipo = tipo; Equipo.TipoEquipoId = tipo?.Id ?? 0; }
    private void OnDepChanged(Dependencia dep) { SelectedDep = dep; Equipo.DependenciaId = dep?.Id ?? 0; }

    private async Task Submit()
    {
        if (string.IsNullOrEmpty(Equipo.Nomenclatura) || Equipo.TipoEquipoId == 0 || Equipo.DependenciaId == 0)
        {
            Snackbar.Add("Complete los campos obligatorios en Identificación y Red", Severity.Warning);
            return;
        }

        var success = await EquipoService.GuardarAsync(Equipo);
        if (success) MudDialog.Close(DialogResult.Ok(true));
    }
}